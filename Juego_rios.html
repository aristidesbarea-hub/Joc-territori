<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Ríos - Selección por Punto (Intenso)</title>
<style>
    body { display: flex; height: 100vh; margin: 0; font-family: Arial, sans-serif}
    #sidebar {
        width: 250px;
        background: #f9f9f9;
        padding: 10px;
        box-sizing: border-box;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    #mapContainer { flex: 1; display: flex; justify-content: center; align-items: flex-start; background: #ddd; }
    svg { border: 1px solid #333; max-width: 95%; max-height: 95%; background: #f2f2f2; }
    
    /* Estilos para comarcas */
    .comarca {
        stroke: black;
        stroke-width: 0.5;
        stroke-linejoin: round;
        fill: transparent;
    }
    
    /* === ESTILOS PARA RÍOS (FIJOS) - COLOR INTENSO === */
    .river { 
        stroke-width: 2; 
        fill: none; 
        stroke-linecap: round; 
        stroke: #3399ff; /* Azul más saturado e intenso */
        cursor: default;
    }

    /* === ESTILOS PARA PUNTOS INTERACTIVOS === */
    .river-target-point {
        fill: #999; /* Gris: el color inicial para seleccionar */
        r: 6;      /* Radio grande para fácil clic en móvil */
        stroke: #333;
        stroke-width: 0.5;
        cursor: pointer;
        transition: fill 0.2s, stroke 0.2s;
    }
    
    .river-target-point:hover {
        fill: #666; /* Un poco más oscuro al pasar el ratón */
    }
    
    .river-target-point.correct {
        fill: #32cd32; /* Verde: Correcto */
        stroke: #1e7e34;
        cursor: default;
    }
    
    .river-target-point.wrong {
        fill: #dc3545; /* Rojo: Incorrecto */
        stroke: #bd2130;
    }

    /* Estilos del juego */
    .back-to-menu-btn {
        display: block;
        width: 100%;
        text-align: center;
        padding: 8px 12px;
        font-size: 1em;
        cursor: pointer;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 5px;
        color: #333;
        text-decoration: none;
        transition: background-color 0.2s;
        margin-bottom: 20px;
    }
    .back-to-menu-btn:hover {
        background-color: #ddd;
    }
    
    .target-river-name { 
        font-weight: bold; 
        color: #333; 
        font-size: 1.2em; 
        background-color: #e6f7ff; 
        padding: 10px; 
        border-radius: 5px; 
        text-align: center;
        margin-top: 10px;
        margin-bottom: 20px;
    }
    #riverButtons button {
        display: none !important;
    }
</style>
</head>
<body>

<div id="sidebar">
    <a href="index.html" class="back-to-menu-btn">← Volver al Menú Principal</a>
    <h2>Juego de Ríos</h2>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <button id="hintButton" style="padding: 6px;">Mostrar Pista</button> 
        <span id="hintText" style="margin-left: 10px; font-weight: bold; color: red;"></span>
    </div>
    
    <div id="riverButtons"></div>
</div>

<div id="mapContainer">
    <svg viewBox="0 0 800 800">
        <g id="backgroundLayer">
            <image href="MRelieve.png" x="0" y="0" width="800" height="800"></image>
        </g>

        <g id="comarcasLayer"></g>
        <g id="riversLayer"></g> 
        <g id="riverPointsLayer"></g> 
    </svg>
</div>

<script>
    // Variables de datos
    let comarcas = [];
    let rios = [];
    // Las variables de ciudades no se usan, pero se mantienen por si la carga de datos es un script único
    let originalCiudades = [];
    let ciudadesConCajas = [];
    
    // Variables de juego
    let answeredCorrectPermanent = new Set();
    let correctlyAnsweredInSession = new Set();
    let targetRiver = null;
    let riverPointsMap = new Map(); 
    
    const X_OFFSET = -100;
    
    // Referencias DOM
    const comarcasLayer = document.getElementById('comarcasLayer');
    const riversLayer = document.getElementById('riversLayer');
    const riverPointsLayer = document.getElementById('riverPointsLayer'); 
    const riverButtonsDiv = document.getElementById('riverButtons');
    const hintButton = document.getElementById('hintButton');
    const hintText = document.getElementById('hintText');
    
    async function loadData() {
        try {
            const timestamp = new Date().getTime();
            const comarcasResponse = await fetch(`comarcas.json?t=${timestamp}`);
            comarcas = await comarcasResponse.json();
            
            const riosResponse = await fetch(`rios.json?t=${timestamp}`);    
            dataRios = await riosResponse.json();

            // Aplanar ríos + afluentes en un solo array
            rios = [];
            if (dataRios.rios) {
                dataRios.rios.forEach(r => {
                    rios.push(r); 
                    if (r.afluentes) {
                        r.afluentes.forEach(a => rios.push(a)); 
                    }
                });
            }
            
            // La carga de ciudades es ignorada.
            
            initializeGame();
        } catch (error) {
            console.error('Error al cargar los datos:', error);
            if (rios.length > 0) initializeGame(); 
        }
    }

    function drawMap() {
        comarcasLayer.innerHTML = "";
        if (comarcas && comarcas.comarcas) {
            comarcas.comarcas.forEach(comarca => {
                comarca.polygons.forEach(polygon => {
                    const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    const pointsStr = polygon.points.map(p => `${p.x},${p.y}`).join(" ");
                    poly.setAttribute("points", pointsStr);
                    poly.setAttribute("class", "comarca");
                    comarcasLayer.appendChild(poly);
                });
            });
        }
        // No se dibuja nada de ciudades
    }
    
    function initializeGame() {
        drawMap();
        drawRiverLines(); 
        
        targetRiver = getRandomRiver();
        if (targetRiver) {
            drawRiverPoints(); 
            updateTargetDisplay();
        }
        hintButton.onclick = giveHint;
    }

    function drawRiverLines() {
        riversLayer.innerHTML = "";
        if (!rios) return;
        const applyOffset = (p) => `${p[0] + X_OFFSET},${p[1]}`;
        
        rios.forEach(river => {
            river.segmentos.forEach(seg => {
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                const pointsStr = seg.puntos.map(applyOffset).join(" ");
                poly.setAttribute("points", pointsStr);
                poly.setAttribute("class", 'river'); 
                riversLayer.appendChild(poly);
            });
        });
    }

    function drawRiverPoints() {
        riverPointsLayer.innerHTML = "";
        riverPointsMap.clear(); 
        if (!rios) return;

        rios.forEach(river => {
            // Usaremos el punto medio del primer segmento
            const firstSegmentPoints = river.segmentos[0].puntos;
            const p = firstSegmentPoints[Math.floor(firstSegmentPoints.length / 2)];
            
            const cx = p[0] + X_OFFSET;
            const cy = p[1];

            const point = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            point.setAttribute("cx", cx);
            point.setAttribute("cy", cy);
            point.dataset.riverName = river.nombre;
            point.setAttribute("class", 'river-target-point');
            
            if (answeredCorrectPermanent.has(river.nombre)) {
                point.classList.add('correct');
                point.onclick = null;
            } else {
                point.onclick = (event) => checkAnswer(event.target.dataset.riverName, event.target);
            }
            
            riverPointsMap.set(river.nombre, point);
            riverPointsLayer.appendChild(point);
        });
    }

    function checkAnswer(clickedRiverName, clickedPoint) {
        if (!targetRiver) return;
        
        if (clickedRiverName === targetRiver.nombre) {
            
            clickedPoint.classList.add('correct');
            clickedPoint.classList.remove('wrong');
            clickedPoint.onclick = null; 
            
            answeredCorrectPermanent.add(targetRiver.nombre);
            correctlyAnsweredInSession.add(targetRiver.nombre);

            riverPointsMap.forEach((point) => {
                if (point.classList.contains('wrong')) {
                    point.classList.remove('wrong');
                }
            });

            setTimeout(() => {
                targetRiver = getRandomRiver();
                if (targetRiver) {
                    updateTargetDisplay();
                    drawRiverPoints();
                }
            }, 1000);
        } else {
            clickedPoint.classList.add('wrong');
        }
    }
    
    function getRandomRiver() {
        if (!rios) return null; 
        const unans = rios.filter(r => !answeredCorrectPermanent.has(r.nombre));
        if (unans.length === 0) {
            showEndGameOptions();
            return null;
        }
        const randomIndex = Math.floor(Math.random() * unans.length);
        return unans[randomIndex];
    }

    function showEndGameOptions() {
        riverButtonsDiv.innerHTML = '';
        const congratsMsg = document.createElement('p');
        congratsMsg.textContent = "¡Felicidades, has acertado todos los ríos!";
        congratsMsg.style.fontWeight = 'bold';
        riverButtonsDiv.appendChild(congratsMsg);
        
        const restartBtn = document.createElement('button');
        restartBtn.textContent = "Reiniciar";
        restartBtn.className = 'btnRiver';
        restartBtn.style.marginTop = '10px';
        restartBtn.onclick = () => restartGame(false);
        riverButtonsDiv.appendChild(restartBtn);
        
        const reviewBtn = document.createElement('button');
        reviewBtn.textContent = "Repasar";
        reviewBtn.className = 'btnRiver';
        reviewBtn.onclick = () => restartGame(true);
        riverButtonsDiv.appendChild(reviewBtn);
    }
    
    function restartGame(reviewMode) {
        if (reviewMode) {
            answeredCorrectPermanent = new Set(correctlyAnsweredInSession);
        } else {
            answeredCorrectPermanent.clear();
        }
        correctlyAnsweredInSession.clear();
        riverButtonsDiv.innerHTML = '';
        riverPointsLayer.innerHTML = '';
        hintText.textContent = '';
        initializeGame();
    }
    
    function updateTargetDisplay() {
        riverButtonsDiv.innerHTML = '';
        if (!targetRiver) return;

        const instruction = document.createElement('p');
        instruction.textContent = "Haz clic en el punto del río:";
        riverButtonsDiv.appendChild(instruction);

        const targetName = document.createElement('p');
        targetName.className = 'target-river-name';
        targetName.textContent = targetRiver.nombre.toUpperCase();
        riverButtonsDiv.appendChild(targetName);
        
        const count = rios.length - answeredCorrectPermanent.size;
        const progress = document.createElement('p');
        progress.textContent = `Ríos restantes: ${count}`;
        progress.style.marginTop = '10px';
        riverButtonsDiv.appendChild(progress);

        hintText.textContent = '';
    }

    function giveHint() {
        if (!targetRiver) return;
        
        hintText.textContent = targetRiver.nombre.toUpperCase();
        
        const targetPoint = riverPointsMap.get(targetRiver.nombre);
        if (targetPoint) {
             targetPoint.classList.add('correct');
             targetPoint.onclick = null; 
        }

        answeredCorrectPermanent.add(targetRiver.nombre);

        setTimeout(() => {
            targetRiver = getRandomRiver();
            if (targetRiver) {
                updateTargetDisplay();
                drawRiverPoints(); 
            }
        }, 1500);
    }


    loadData();
</script>
</body>
</html>
