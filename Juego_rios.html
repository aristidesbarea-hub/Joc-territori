<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Ríos - Selección por Punto (Pista Visual)</title>
<style>
    body { display: flex; height: 100vh; margin: 0; font-family: Arial, sans-serif}
    #sidebar {
        width: 250px;
        background: #f9f9f9;
        padding: 10px;
        box-sizing: border-box;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    #mapContainer { flex: 1; display: flex; justify-content: center; align-items: flex-start; background: #ddd; position: relative; }
    svg { border: 1px solid #333; max-width: 95%; max-height: 95%; background: #f2f2f2; }

    /* Estilos para comarcas */
    .comarca { stroke: black; stroke-width: 0.5; stroke-linejoin: round; fill: transparent; }

    /* Estilos ríos */
    .river { stroke-width: 2; fill: none; stroke-linecap: round; stroke: #3399ff; cursor: default; transition: stroke 0.3s; }
    .river.hint-active { stroke: #ffc107; stroke-width: 3.5; }
    .river.correct-river { stroke: #0066ff; stroke-width: 3; }

    /* Puntos interactivos */
    .river-target-point { fill: #999; r: 6; stroke: #333; stroke-width: 0.5; cursor: pointer; transition: fill 0.2s, stroke 0.2s; }
    .river-target-point:hover { fill: #666; }
    .river-target-point.correct { fill: #32cd32; stroke: #1e7e34; cursor: default; }
    .river-target-point.wrong { fill: #dc3545; stroke: #bd2130; }
    .river-target-point.hint-used { fill: #ffc107; stroke: #ff9800; cursor: default; }
    .blinking { animation: blink 1s infinite; }
    @keyframes blink { 0%,100% { fill:#ffc107; } 50% { fill:#fff200; } }

    /* Estilos juego */
    .back-to-menu-btn { display: block; width: 100%; text-align: center; padding: 8px 12px; font-size: 1em; cursor: pointer; background-color: #eee; border: 1px solid #ccc; border-radius: 5px; color: #333; text-decoration: none; transition: background-color 0.2s; margin-bottom: 20px; }
    .back-to-menu-btn:hover { background-color: #ddd; }
    .target-river-name { font-weight: bold; color: #333; font-size: 1.2em; background-color: #e6f7ff; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px; margin-bottom: 20px; }
    #riverButtons button { display: none !important; }

    /* Nombre grande sobre el mapa */
    #bigRiverName {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        font-weight: bold;
        color: rgba(0, 100, 255, 0.9);
        text-shadow: 2px 2px 5px white;
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
    }
    #bigRiverName.visible { opacity: 1; transition: none; }
    #bigRiverName.fade-out { opacity: 0; transition: opacity 2s ease-out; }
</style>
</head>
<body>

<div id="sidebar">
    <a href="../index.html" class="back-to-menu-btn">← Volver al Menú Principal</a>
    <h2>Juego de Ríos</h2>

    <div>
        <h3>Puntuación: <span id="score">0</span></h3>
    </div>

    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <button id="hintButton" style="padding: 6px;">Mostrar Pista</button> 
        <span id="hintText" style="margin-left: 10px; font-weight: bold; color: red;"></span>
    </div>
    <div id="riverButtons"></div>

    <div style="margin-top:20px;">
        <h3>Ríos acertados con pista:</h3>
        <ul id="hintedRiversList" style="padding-left: 20px;"></ul>
    </div>
</div>

<div id="mapContainer">
    <svg viewBox="0 0 800 800">
        <g id="backgroundLayer">
            <image href="MRelieve.png" x="0" y="0" width="800" height="800"></image>
        </g>
        <g id="comarcasLayer"></g>
        <g id="riversLayer"></g>
        <g id="riverPointsLayer"></g>
    </svg>
    <div id="bigRiverName"></div>
</div>

<script>
let comarcas=[], rios=[], answeredCorrectPermanent=new Set(), correctlyAnsweredInSession=new Set(), hintedRivers=new Set();
let targetRiver=null, riverPointsMap=new Map(), riverPolylinesMap=new Map(), hintUsedForTarget=false;
let score=0;
const X_OFFSET=-100;
const comarcasLayer=document.getElementById('comarcasLayer');
const riversLayer=document.getElementById('riversLayer');
const riverPointsLayer=document.getElementById('riverPointsLayer');
const riverButtonsDiv=document.getElementById('riverButtons');
const hintButton=document.getElementById('hintButton');
const hintText=document.getElementById('hintText');
const bigRiverNameDiv=document.getElementById('bigRiverName');
const hintedRiversList=document.getElementById('hintedRiversList');
const scoreSpan=document.getElementById('score');

async function loadData(){
    try{
        const ts=new Date().getTime();
        comarcas=(await (await fetch(`comarcas.json?t=${ts}`)).json());
        const dataRios=(await (await fetch(`rios.json?t=${ts}`)).json());
        rios=[];
        if(dataRios.rios){
            dataRios.rios.forEach(r=>{
                rios.push(r);
                if(r.afluentes) r.afluentes.forEach(a=>rios.push(a));
            });
        }
        initializeGame();
    }catch(e){console.error('Error:',e); if(rios.length>0) initializeGame();}
}

function drawMap(){
    comarcasLayer.innerHTML="";
    if(comarcas && comarcas.comarcas){
        comarcas.comarcas.forEach(c=>{
            c.polygons.forEach(p=>{
                const poly=document.createElementNS("http://www.w3.org/2000/svg","polygon");
                poly.setAttribute("points",p.points.map(pt=>`${pt.x},${pt.y}`).join(" "));
                poly.setAttribute("class","comarca");
                comarcasLayer.appendChild(poly);
            });
        });
    }
}

function initializeGame(){
    drawMap(); drawRiverLines();
    targetRiver=getRandomRiver(); hintUsedForTarget=false;
    if(targetRiver){ drawRiverPoints(); updateTargetDisplay(); }
    hintButton.onclick=giveHint;
}

function drawRiverLines(){
    riversLayer.innerHTML=""; riverPolylinesMap.clear();
    if(!rios) return;
    const offset=p=>`${p[0]+X_OFFSET},${p[1]}`;
    rios.forEach(r=>{
        const g=document.createElementNS("http://www.w3.org/2000/svg","g");
        r.segmentos.forEach(s=>{
            const poly=document.createElementNS("http://www.w3.org/2000/svg","polyline");
            poly.setAttribute("points",s.puntos.map(offset).join(" "));
            poly.setAttribute("class","river");
            g.appendChild(poly);
        });
        riversLayer.appendChild(g);
        riverPolylinesMap.set(r.nombre,g);
    });
}

function drawRiverPoints(){
    riverPointsLayer.innerHTML=""; riverPointsMap.clear();
    if(!rios) return;
    rios.forEach(r=>{
        const pts=r.segmentos[0].puntos;
        const p=pts[Math.floor(pts.length/2)];
        const point=document.createElementNS("http://www.w3.org/2000/svg","circle");
        point.setAttribute("cx",p[0]+X_OFFSET); point.setAttribute("cy",p[1]);
        point.dataset.riverName=r.nombre; point.setAttribute("class","river-target-point");

        if(answeredCorrectPermanent.has(r.nombre)){
            if(hintedRivers.has(r.nombre)) point.classList.add('hint-used');
            else point.classList.add('correct');
            point.onclick=null;
        } else point.onclick=e=>checkAnswer(e.target.dataset.riverName,e.target);

        riverPointsMap.set(r.nombre,point);
        riverPointsLayer.appendChild(point);
    });
}

function addRiverToHintedList(name){
    const li=document.createElement('li'); li.textContent=name;
    hintedRiversList.appendChild(li);
}

function updateScore(points){
    score+=points; scoreSpan.textContent=score;
}

function checkAnswer(name,point){
    if(!targetRiver) return;
    if(name===targetRiver.nombre){
        answeredCorrectPermanent.add(targetRiver.nombre);
        correctlyAnsweredInSession.add(targetRiver.nombre);
        if(hintUsedForTarget){
            hintedRivers.add(targetRiver.nombre);
            point.classList.add('hint-used'); point.dataset.hintUsed='true';
            addRiverToHintedList(targetRiver.nombre);
            updateScore(0); // acierto con pista
        }else{ point.classList.add('correct'); updateScore(10); } // acierto normal

        const g=riverPolylinesMap.get(targetRiver.nombre);
        if(g) g.querySelectorAll('.river').forEach(poly=>{ poly.classList.remove('hint-active'); poly.classList.add('correct-river'); });
        riverPointsMap.forEach(p=>p.classList.remove('wrong'));

        setTimeout(()=>{
            targetRiver=getRandomRiver(); hintUsedForTarget=false;
            if(targetRiver){ updateTargetDisplay(); drawRiverPoints(); }
        },1000);
    } else { point.classList.add('wrong'); updateScore(-1); } // fallo
}

function getRandomRiver(){
    if(!rios) return null;
    const unans=rios.filter(r=>!answeredCorrectPermanent.has(r.nombre));
    if(unans.length===0){ showEndGameOptions(); return null; }
    return unans[Math.floor(Math.random()*unans.length)];
}

function showEndGameOptions(){
    riverButtonsDiv.innerHTML='';
    const msg=document.createElement('p'); msg.textContent="¡Felicidades, has acertado todos los ríos!"; msg.style.fontWeight='bold';
    riverButtonsDiv.appendChild(msg);
    const restart=document.createElement('button'); restart.textContent="Reiniciar"; restart.onclick=()=>restartGame(false);
    riverButtonsDiv.appendChild(restart);
    const review=document.createElement('button'); review.textContent="Repasar"; review.onclick=()=>restartGame(true);
    riverButtonsDiv.appendChild(review);
}

function restartGame(review){
    if(review) answeredCorrectPermanent=new Set(correctlyAnsweredInSession);
    else answeredCorrectPermanent.clear();
    correctlyAnsweredInSession.clear();
    riverPointsLayer.innerHTML=''; riverButtonsDiv.innerHTML=''; hintText.textContent='';
    hintedRiversList.innerHTML=''; score=0; scoreSpan.textContent=score;
    initializeGame();
}

function updateTargetDisplay(){
    riverButtonsDiv.innerHTML='';
    if(!targetRiver) return;
    const p1=document.createElement('p'); p1.textContent="Haz clic en el punto del río:"; riverButtonsDiv.appendChild(p1);
    const targetName=document.createElement('p'); targetName.className='target-river-name'; targetName.textContent=targetRiver.nombre.toUpperCase(); riverButtonsDiv.appendChild(targetName);
    const p2=document.createElement('p'); p2.textContent=`Ríos restantes: ${rios.length-answeredCorrectPermanent.size}`; riverButtonsDiv.appendChild(p2);
    hintText.textContent='';

    bigRiverNameDiv.textContent=targetRiver.nombre.toUpperCase();
    bigRiverNameDiv.className='visible';
    setTimeout(()=>{ bigRiverNameDiv.className='fade-out'; },500);
}

function giveHint(){
    if(!targetRiver || hintUsedForTarget) return;
    hintText.textContent=targetRiver.nombre.toUpperCase();
    hintUsedForTarget=true;
    const g=riverPolylinesMap.get(targetRiver.nombre);
    if(g) g.querySelectorAll('.river').forEach(poly=>poly.classList.add('hint-active'));
    const point=riverPointsMap.get(targetRiver.nombre);
    if(point) point.classList.add('blinking');
}

loadData();
</script>
</body>
</html>
